(function(){var n,r,e,u,o,f,c,s,h,t,i;h=require("crypto"),i=require("../models"),t=console.log,n=i.Category,r=i.Event,u=i.Reply,o=i.Review,f=i.User,e=10,s=function(n){var t;return n?(t=h.createHash("sha1"),t.update(n),t.digest("hex")):null},c=function(){return n.remove(function(){return[].forEach(function(i){return n.create({name:i},function(n,r){return t("create category "+i),t(r)})})})},exports.active=function(i){return i.get("/category",function(t,i,r){return n.find(function(n,t){return n?r(n):i.send(t)})}),i.post("/category",function(t,i,r){var u;return(u=t.param("name"),!u)?r("no category name"):n.create({name:u},function(n,t){return n?r(n):i.send(t)})}),i.get("/event",function(t,i,u){var o,f,s;return f=t.param("page"),o=t.param("category"),f=Number(f||0),s=f*e,o?n.findOne({name:o},function(n,t){return n?u(n):t?r.find({_category:t._id},null,{skip:s,limit:e}).populate("_author _category _participators _replies _reviews").exec(function(n,t){return n?u(n):i.send(t)}):u("no category")}):r.find({},null,{skip:s,limit:e}).populate("_author _category _participators _replies _reviews").exec(function(n,t){return n?u(n):i.send(t)})}),i.get("/event/:id",function(n,t,i){var u;return u=n.param("id"),r.findById(u,function(n,r){return n?i(n):r?t.send(r):i("no event")})}),i.post("/event/create",function(t,i,u){var o,s,h,f,c,l,a,v,y,p,e,b,w;return t.session.user?(w=t.param("title"),h=t.param("content"),s=t.param("category"),b=Number(t.param("price")),o=t.param("address"),a=t.param("location"),l=Number(t.param("latitude")),v=Number(t.param("longitude")),y=Number(t.param("max_participators")),c=t.param("due_day_start"),f=t.param("due_day_end"),e=t.param("on_day_start"),p=t.param("on_day_end"),!w)?u("no title"):h?s?o?a?l?v?y?f?e?p?f<c?u("date errorA"):e<f?u("date errorB"):n.findOne({name:s},function(n,s){return n?u(n):s?r.create({title:w.trim(),content:h.trim(),_category:s._id,_author:t.session.user._id,price:b,address:o.trim(),location:a.trim(),latitude:l,longitude:v,max_participators:y,_participators:[t.session.user._id],due_day_start:c,due_day_end:f,on_day_start:e,on_day_end:p},function(n,t){return n?u(n):i.send(t)}):u("no category")}):u("no on_day_end"):u("no on_day_start"):u("no due_day_end"):u("no max_participators"):u("no longitude"):u("no latitude"):u("no location"):u("no address"):u("no category"):u("no content"):u("not login")}),i.get("/reply",function(n,t,i){return u.find(function(n,r){return n?i(n):t.send(r)})}),i.post("/reply",function(n,t,i){var r,f,e;return e=n.param("_id"),f=n.param("_author"),r=n.param("content"),u.find(function(n,r){return n?i(n):t.send(r)})}),i.post("/reply/:id",function(n,t,i){var r,f,e;return f=n.param("id"),e=n.param("_author"),r=n.param("content"),u.findById(f,function(n,f){return n?i(n):f?u.create({_author:author,content:r},function(n,r){return n?i(n):(f._comment.push(r._id),f.save(function(n){return n?i(n):t.send(r)}))}):i("no reply")})}),i.get("/review",function(n,t,i){return o.find(function(n,r){return n?i(n):t.send(r)})}),i.post("/review",function(n,t,i){return o.find(function(n,r){return n?i(n):t.send(r)})}),i.get("/user",function(n,t,i){return f.find(function(n,r){return n?i(n):t.send(r)})}),i.get("/user/me",function(n,t,i){return n.session.user?t.send(n.session.user):i("not login")}),i.post("/user/create",function(n,t,i){var r,u;return r=n.param("login"),u=n.param("password"),f.create({login:r,password:s(u)},function(n,r){return n?i(n):t.send(r)})}),i.post("/user/login",function(n,i,r){var e,u;return e=n.param("login"),u=n.param("password"),e||r("no login"),u||r("no password"),f.findOne({login:e},function(f,e){return f?r(f):e?(t(e),t(u),u=s(u),t(e.password),t(u),u===e.password?(n.session.user=e,i.send("success")):r("not match password")):r("no user")})}),i.get("/user/logout",function(n,t){return n.session.user=null,t.send("success")}),i.get("/user/:id",function(n,t,i){var r;return r=n.param("id"),f.findById(r).populate("_reviews _replies _create_events").exec(function(n,r){return n?i(n):r?t.send(r):i("no user")})})}}).call(this)